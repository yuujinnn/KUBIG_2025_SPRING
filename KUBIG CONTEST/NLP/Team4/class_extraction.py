import os
import json
import sys
import ast
from tqdm import tqdm
from openai import OpenAI

# OpenAI API 설정
OPENAI_API_KEY = "key"
openai_client = OpenAI(api_key=OPENAI_API_KEY)

sys.stdout.reconfigure(encoding='utf-8')

# disease_classes 예시 (class.txt 파일을 읽어온 뒤, 파이썬 딕셔너리로 구성했다고 가정)
# 실제 상황에 맞춰 '귀코목질환', '근골격질환', '기타' 외 다른 카테고리도 들어갈 수 있습니다.
disease_classes = {
    "감염성질환": [
        "HIV 감염", "결핵", "곰팡이 감염", "광우병", "구순염", "구순포진", "뎅기열", "디프테리아",
        "라임병", "말라리아", "매독", "반코마이신 내성 장알균 감염증", "발진티푸스", "불명열", 
        "성병", "수두", "수족구병", "심내막염", "요충증", "인유두종 바이러스 감염증", "일본 뇌염",
        "임파선염", "장티푸스", "조류 인플루엔자 인체감염증", "첨형 콘딜로마", "칸디다성 구내염",
        "콜레라", "파상풍", "패혈증", "풍진", "헤르페스 바이러스 감염", "호산구 증가증", "홍역",
        "후천성 면역결핍증"
    ],
    "귀코목질환": [
        "고막염", "구강암", "급성 중이염", "꽃가루 알레르기", "난청", "노인성 난청", "만성 부비동염",
        "만성 비염", "만성 중이염", "메니에르병", "부비동염", "비중격 만곡", "비출혈", "상기도 감염",
        "수면 무호흡증", "알레르기 비염", "외이도염", "이명", "이석증", "인후두염", "편도결석", 
        "편도선염", "편도암", "후두암", "후비루"
    ],
    "근골격질환": [
        "VDT 증후군", "강직성 척추염", "거북목 증후군", "건초염", "결절종", "골감소증", "골관절염",
        "골수염", "골육종", "관절염", "구루병", "근감소증", "내반슬", "류마티스 관절염", "무지외반증",
        "선천성 편평발", "소아마비", "손목 수근관 증후군", "십자 인대 손상", "아킬레스 건 파열",
        "아킬레스 건염", "염좌", "외반슬", "요추 추간판 탈출증", "요추관 협착증", "족저 근막염",
        "좌골신경통", "지체장애", "척추측만증", "통풍", "통풍성 관절염"
    ],
    "기타": [
        "괴혈병", "납 중독", "냉방병", "대사 증후군", "비만", "새집 증후군", "알코올성 간질환",
        "음식 알레르기", "이상지질혈증", "전신 홍반성 낭창", "춘곤증"
    ],
    "뇌신경정신질환": [
        "강박 장애", "건강염려증", "경추 추간판 탈출증", "공황 장애", "금단 현상", "기면증",
        "기억상실증", "뇌경색", "뇌동맥류", "뇌사", "뇌성 마비", "뇌염", "뇌전증", "뇌졸중",
        "뇌출혈", "다발성 경화증", "다발성 신경병증", "뚜렛 증후군", "레이노병", "망상 장애",
        "모야모야병", "바이러스성 뇌수막염", "박테리아성 뇌수막염", "반사회성 인격장애", "발작",
        "불면증", "불안 장애", "삼차 신경병증", "섬망", "섭식 장애", "성인 주의력 결핍 과잉행동장애",
        "수면 장애", "신경성 폭식증", "실어증", "안면 마비", "알츠하이머병", "알코올 의존성",
        "알코올성 치매", "양극성 장애", "외상 후 스트레스 장애", "우울증", "인터넷 중독",
        "자폐증", "자폐스펙트럼장애", "조현병", "주의력결핍 과잉행동장애", "중증 근무력증",
        "지적장애", "진전", "척추 종양", "치매", "틱 장애", "파킨슨병", "편두통", "편집성 인격장애",
        "폐소공포증", "하지불안증후군", "해리 장애", "행동 및 충동 장애", "히스테리성 인격장애"
    ],
    "눈질환": [
        "각막염", "결막염", "근시", "난시", "노안", "녹내장", "당뇨망막병증", "망막 박리", "백내장",
        "복시", "비문증", "사시", "색약", "시신경염", "안검하수", "안구 건조증", "안암",
        "알레르기성 결막염", "야맹증", "약시", "출혈성 결막염", "포도막염", "황반변성"
    ],
    "성형미용 및 재건": [
        "구개열", "구순열", "돌출입", "두개 유합증", "사각턱", "안면 골절", "안면 비대칭",
        "외꺼풀", "주걱턱"
    ],
    "소아청소년질환": [
        "가와사키병", "과숙아", "기관지폐 형성이상", "라이 증후군", "미숙아 망막병증", "발달 장애",
        "방실 중격 결손", "선천성 담관 폐쇄증", "성조숙증", "성홍열", "신경모세포종", "신생아 경련",
        "신생아 괴사성 장염", "신생아 호흡곤란증후군", "신생아 황달", "심방 중격 결손", "아스퍼거 증후군",
        "영아 돌연사 증후군", "영아 비대성 유문협착증", "유당분해효소결핍증", "유행성 이하선염",
        "저신장증", "제대 탈장", "팔로 사 징후"
    ],
    "소화기질환": [
        "간 전이", "간경화", "간농양", "간성 뇌증", "간염", "궤양성 대장염", "급성 A형 간염",
        "급성 B형 간염", "급성 C형 간염", "급성 담낭염", "급성 바이러스성 간염", "급성 위장염",
        "급성 충수염", "급성 췌장염", "기능성 위장 장애", "노로바이러스 장염", "담낭 용종", "담석",
        "대장 용종", "덤핑 증후군", "만성 B형 간염", "만성 C형 간염", "만성 담낭염", "만성 위염",
        "만성 췌장염", "맹장염", "바이러스성 장염", "변비", "변실금", "복막염", "복부 통증",
        "복수", "석회화 담낭", "선천성 거대결장증", "세균성 이질", "소장암", "소화불량",
        "식도 정맥류", "식도염", "지방간"
    ],
    "신장비뇨기질환": [
        "고나트륨혈증", "고마그네슘혈증", "고칼륨혈증", "고환염", "과민성 방광", "급성 방광염",
        "급성 신부전", "급성 신우신염", "남성 불임", "만성 신부전", "만성 신우신염", "만성 전립선염",
        "말기 신질환", "무정자증", "방광요관 역류", "배뇨장애", "복압성 요실금", "사구체신염",
        "서혜부 탈장", "성기능장애", "신부전", "신장 결석", "신증후군", "야뇨증", "요관 협착",
        "요도하열", "요독증", "요로결석", "요실금", "음낭수종", "임질", "잠복고환증", "조루증",
        "포경", "혈뇨"
    ],
    "여성질환": [
        "골반 염증성 질환", "과다월경", "급성 질염", "난산", "난소", "난관 이상", "난소난관염",
        "다낭성 난소 증후군", "다태아", "무월경", "배란통", "분만 후 출혈", "비정상적 자궁, 질 출혈",
        "산욕열", "산후 우울증", "생식선 및 생식 세포의 신생물", "습관성 유산", "양수색전증",
        "여성 불임", "외음부암", "월경전 증후군", "유산", "이상 태위", "임신성 고혈압",
        "임신성 당뇨병", "자간전증", "자간증", "자궁 경부의 이형성증", "자궁 내 성장 지연",
        "자궁 발육부전", "자궁 외 임신", "자궁 탈출증", "자궁경관무력증", "자궁경부염",
        "자궁근종", "자궁내막 이상증식증", "자궁내막증", "자궁선근증", "전치 태반", "조기 양막 파열",
        "조기 진통", "조기 폐경", "조산", "태반 조기 박리", "태아 알코올 증후군", "폐경",
        "회음 열상"
    ],
    "유방내분비질환": [
        "갈색세포종", "갑상선 결절", "갑상선기능저하증", "갑상선기능항진증", "갑상선염", "고칼슘혈증",
        "골다공증", "뇌하수체 기능 항진", "뇌하수체 기능부전", "뇌하수체 양성 및 악성 신생물",
        "당뇨병", "당뇨병성 말초신경병증", "당뇨병성 족부 질환", "당뇨병성 케톤산증", "말단비대증",
        "부갑상선기능저하증", "부갑상선기능항진증", "부갑상선암", "부신 기능부전", "성장호르몬 결핍증",
        "여성형 유방", "요붕증", "유방 종양", "유선염", "제1형 당뇨병", "쿠싱 증후군", "흉선암"
    ],
    "유전질환": [
        "갈락토오스혈증", "골형성부전증", "근긴장성 이영양증", "다운 증후군", "당원 축적병", "묘성 증후군",
        "선천성 갑상선기능저하증", "선천성 기형", "신경섬유종", "연골무형성증", "윌리암스 증후군",
        "척수구근 근위축증", "척수근육위축", "클라인펠터 증후군", "터너 증후군", "페닐케톤뇨증",
        "프라더 윌리 증후군", "헌팅톤 병", "혈우병"
    ],
    "응급질환": [
        "고산병", "과호흡 증후군", "광견병", "구획 증후군", "급성 류마티스성 열", "기도 폐쇄",
        "대동맥 박리", "대사성 산증", "대사성 알칼리증", "독성 쇼크 증후군", "두통", "복강 내 출혈",
        "복부 대동맥류", "부정맥", "비브리오 패혈증", "소화관 내 이물", "수부 외상", "식중독",
        "아나필락시스", "악성 고열증", "압궤 손상", "약물 알레르기", "열 피로", "열사병",
        "외상성 뇌 손상", "외상성 척수 손상", "일산화탄소 중독", "저나트륨혈증", "저마그네슘혈증",
        "저체온증", "저칼륨혈증", "저칼슘혈증", "저혈당증", "호흡성 산증", "호흡성 알칼리증",
        "혼수", "화상", "횡격막 탈장", "횡문근융해증", "흉통"
    ],
    "종양혈액질환": [
        "간세포성 암종", "간의 양성 신생물", "갑상선암", "고환 종양", "골수증식종양", "골수형성이상증후군",
        "교모세포종", "급성골수성백혈병", "급성림프모구백혈병", "난소 낭종", "난소암", "난소의 양성 종양",
        "뇌종양", "다발골수종", "담관암", "담낭암", "대장암", "대장의 양성 종양", "두경부암", "림프종",
        "만성골수백혈병", "만성림프구백혈병", "면역결핍증", "면역혈소판감소증", "방광암", "백혈병",
        "범혈구감소증", "부신 종양", "부신암", "비소세포성 폐암", "비인두 종양", "소세포성 폐암",
        "식도암", "위암", "유방암", "육종", "자가면역 질환", "자가면역용혈질환", "자궁 상피 내 암종",
        "자궁경부암", "자궁내막암", "전립선암", "전이 암", "조기 위암", "직장암", "질암", "척수 종양",
        "철결핍빈혈", "췌장암", "파종혈관내응고", "폐암", "피부암", "피부의 양성 종양", "항문암",
        "호중구감소증"
    ],
    "치과질환": [
        "만성 치주염", "매복 사랑니", "치아 우식증[충치]", "치은염", "치조골염", "턱관절 탈구"
    ],
    "피부질환": [
        "건선", "기미", "내향성 손발톱", "농가진", "단순 포진", "대상포진", "동상", "두드러기",
        "두부 백선", "땀띠", "만성 두드러기", "모공성 각화증", "모낭염", "무좀", "봉와직염", "비듬",
        "사마귀", "사면발이증", "섬유종", "소양증", "습진", "아토피성 피부염", "안면 홍조증",
        "약물 발진", "여드름", "옴", "옻 중독", "욕창", "주근깨", "쥐젖", "지루성 피부염",
        "지방종", "켈로이드", "콜린성 두드러기", "탈모증", "티눈", "피부건조증", "피부염", "흉터"
    ],
    "호흡기질환": [
        "공기가슴증(기흉)", "급성 기관지염", "농흉", "늑막염", "만성 기관지염", "만성 기침",
        "만성 폐쇄성 폐질환", "백일해", "병원 감염성 폐렴", "성인 호흡곤란 증후군", "신종 플루",
        "인플루엔자", "중동 호흡기 증후군", "중증 급성 호흡기 증후군", "지역사회성 폐렴", "천식",
        "코로나-19", "폐결핵", "폐기종", "폐렴", "흡인성 폐렴"
    ]
}


intention_classes = [
    "검진", "식이, 생활", "약물", "예방", "운동", "원인", "재활", "정의", "증상", "진단", "치료"
]

def prompt_llm_extraction(current_query):
    """
    LLM에게 질의를 보내고, 'Python 딕셔너리' 형태의 응답을 받아
    실제 Python 딕셔너리로 변환하여 반환합니다.
    """

    # 질병 카테고리 목록을 프롬프트에 포함시켜 모델이 참고하도록 합니다.
    # 실제 사용 시, disease_classes가 매우 길다면 전부 넣지 않고 대표 예시나 축약본을 넣어도 됩니다.
    disease_prompt_text = []
    for category, disease_list in disease_classes.items():
        disease_prompt_text.append(f"{category}: {', '.join(disease_list)}")
    disease_prompt_str = "\n".join(disease_prompt_text)

    # 프롬프트 구성
    response = openai_client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {
                "role": "system",
                "content": (
                    "You are an AI trained for medical question classification. Your task is to identify key medical information "
                    "from user questions, including the disease category, specific disease name, and the intention behind the question. "
                    "You must choose the disease category and disease name strictly from the provided disease_classes list. "
                    "If the question references a disease not in the list, set 'disease_category' to '기타' and 'disease_name' to 'unknown'. "
                    "For intention, use one of the following: " + ", ".join(intention_classes)
                )
            },
            {
                "role": "user",
                "content": (
                    f"Below is the dictionary of disease categories and their diseases:\n\n"
                    f"{disease_prompt_str}\n\n"
                    f"Now, based on this dictionary, please analyze the following user question:\n\n"
                    f"\"{current_query}\"\n\n"
                    f"Below is the list of intentions. Extract one of the intentions according to the question above.\n\n"
                    f"{intention_classes}\n\n"
                    "Instructions:\n"
                    "1) Determine which single disease category best fits the question. If no match, use '기타'.\n"
                    "2) Identify the specific disease name from the provided list if possible; otherwise, 'unknown'.\n"
                    "3) Identify the question's main intention (e.g., '증상', '검진', '치료', ...).\n\n"
                    "**Your Response:** Return the result **in Python dictionary format** as shown below:\n"
                    "{\n"
                    "    'disease_category': 'extracted_category',\n"
                    "    'disease_name': 'extracted_disease_name',\n"
                    "    'intention': 'extracted_intention'\n"
                    "}\n"
                )
            }
        ]
    )

    response_text = response.choices[0].message.content.strip()

    # 디버깅용 출력
    print("Model Response:", response_text)

    # LLM의 문자열 응답을 Python 딕셔너리로 안전하게 변환
    try:
        result = ast.literal_eval(response_text)
        if not isinstance(result, dict):
            raise ValueError("Response is not a dictionary.")
    except Exception as e:
        print(f"딕셔너리 형태로 변환 실패: {e}")
        return {
            "disease_category": "unknown",
            "disease_name": "unknown",
            "intention": "unknown"
        }

    return result
